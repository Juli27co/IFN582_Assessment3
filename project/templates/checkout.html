{% extends 'base.html' %}

{% import 'bootstrap5/form.html' as wtf %}

{% block main %}
<style>
.btn-navbar{background-color:#212529;border-color:#212529;color:#fff;}
.btn-navbar:hover,.btn-navbar:focus{background-color:#1a1e21;border-color:#1a1e21;color:#fff;}
.min-w-40{min-width:40px;display:inline-block;}
</style>

<div class="container my-5">
  <div class="row g-4">

    <div class="col-12 col-lg-7">
      <div class="card">
        <div class="card-body">
          <h3 class="mb-4 d-flex justify-content-between align-items-center">
            <span>Checkout</span>
            <form action="{{ url_for('main.cart_clear') }}" method="post" class="d-inline">
              {{ clear_form.hidden_tag() }}
              <button type="submit" class="btn btn-outline-danger btn-sm">Clear Basket</button>
            </form>
          </h3>

          {% if not cart.items %}
            <div class="alert alert-warning mb-4">Your basket is empty. Please add items before checkout.</div>
          {% endif %}

          <div class="table-responsive">
            <table class="table align-middle" id="cart-table">
              <thead>
                <tr>
                  <th style="width:90px;">Photo</th>
                  <th>Item</th>
                  <th class="text-center" style="width:110px;">Qty</th>
                  <th class="text-end" style="width:120px;">Unit</th>
                  <th class="text-end" style="width:120px;">Line</th>
                  <th style="width:90px;"></th>
                </tr>
              </thead>
              <tbody>
                {% for it in cart.items %}
                <tr>
                  <td>
                    <img src="{{ url_for('static', filename='img/' ~ (it.image_filename or 'placeholder.jpg')) }}"
                         alt="{{ it.title or 'item' }}"
                         style="width:70px;height:70px;object-fit:cover;border-radius:8px;">
                  </td>
                  <td>
                    <div class="fw-semibold">{{ it.title or ('Service #' ~ (it.service.id if it.service else '')) }}</div>
                  </td>
                  <td class="text-center">
                    <form action="{{ url_for('main.cart_update') }}" method="post" class="d-inline-flex gap-2 justify-content-center">
                      <input type="hidden" name="item_id" value="{{ it.id }}">
                      <input name="qty" type="number" min="1" max="99" value="{{ it.qty }}" class="form-control form-control-sm" style="width:70px;">
                      <button class="btn btn-outline-secondary btn-sm">Update</button>
                    </form>
                  </td>
                  <td class="text-end">$ {{ '%.2f'|format((it.unit_price or 0)|float) }}</td>
                  <td class="text-end">$ {{ '%.2f'|format(((it.unit_price or 0)|float * (it.qty or 1)) ) }}</td>
                  <td class="text-end">
                    <form action="{{ url_for('main.cart_remove') }}" method="post" class="d-inline">
                      <input type="hidden" name="item_id" value="{{ it.id }}">
                      <button class="btn btn-outline-danger btn-sm">Remove</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
                {% if not cart.items %}
                <tr>
                  <td colspan="6" class="text-center text-muted">No items selected.</td>
                </tr>
                {% endif %}
              </tbody>
              <tfoot>
                <tr>
                  <th colspan="4" class="text-end">Total</th>
                  <th class="text-end">$ {{ '%.2f'|format(total|float) }}</th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-body">
          <h4 class="mb-3">Your details</h4>
          <form method="post" action="{{ url_for('main.checkout') }}" novalidate>
            {{ form.hidden_tag() }}
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">{{ form.full_name.label.text }}</label>
                {{ form.full_name(class="form-control", placeholder="Full name") }}
              </div>
              <div class="col-md-6">
                <label class="form-label">{{ form.email.label.text }}</label>
                {{ form.email(class="form-control", placeholder="you@example.com") }}
              </div>
              <div class="col-md-6">
                <label class="form-label">{{ form.phone.label.text }}</label>
                {{ form.phone(class="form-control", placeholder="+61...") }}
              </div>
              <div class="col-md-6">
                <label class="form-label">{{ form.payment_method.label.text }}</label>
                {{ form.payment_method(class="form-select") }}
              </div>
              <div class="col-12">
                <label class="form-label d-block">{{ form.fulfilment_method.label.text }}</label>
                <div class="d-flex flex-wrap gap-3">
                  {% for sub in form.fulfilment_method %}
                    <label class="d-flex align-items-center gap-2">
                      {{ sub() }} {{ sub.label.text }}
                    </label>
                  {% endfor %}
                </div>
              </div>
              <div class="col-12">
                <div class="d-flex justify-content-center">
                  <button class="btn btn-navbar btn-lg px-4">Review & Place Order</button>
                </div>
              </div>
            </div>
          </form>
          {% if form.errors %}
            <div class="alert alert-danger mt-3">Please fix the highlighted errors.</div>
          {% endif %}
        </div>
      </div>
    </div>

<!-- orser summary pnnel (from here)-->
    <div class="col-12 col-lg-5">
      <div class="card">
        <div class="card-body">
          <h5 class="mb-3">Order Summary</h5>
          {% if cart.items %}
            <ul class="list-unstyled mb-3" id="summary-list">
              {% for it in cart.items %}
             <li class="d-flex align-items-center justify-content-between mb-3 p-2 border rounded-3"
                  data-id="{{ it.id }}" data-unit="{{ (it.unit_price or 0)|float }}">
                <div class="d-flex align-items-center gap-3 order-con">
                  <img src="{{ url_for('static', filename='img/' ~ it.service.coverImage) }}"
                       alt="{{ it.service.name or 'item' }}"
                       style="width:64px;height:64px;object-fit:cover;border-radius:10px;">
                  <div class="order-con">
                    <div class="d-flex justify-content-between align-items-end">
                      <p class="fw-semibold">#{{ loop.index }} {{ it.service.name }}</p>
                      <p class="text-muted small">${{ '%.2f'|format((it.service.price)|float) }}</p>
                    </div>
                    <div class="mb-3">
                      <p>{{ it.photographer.firstName }} {{ it.photographer.lastName }}({{ it.photographer.availability }})</p>
                    </div>  
                      <div class="text-muted small d-flex justify-content-between">
                        <p>Session Type: {{ it.type.type }}</p>
                        <p>${{ '%.2f'|format((it.type.price)|float) }}</p>
                      </div>
                      {% if it.addon %}
                        <div class="text-muted small d-flex justify-content-between">
                          <p>{{ it.addon.addOn }}</p>
                          <p>${{ '%.2f'|format((it.addon.price)|float) }}</p>
                        </div>
                      {% endif %}
                  </div>
                </div>

                <div class="d-flex align-items-center gap-2">
                  <div class="text-end ms-2" style="width:90px;">
                    <div class="fw-semibold line-total">{{"$%.2f"|format(it.subtotal|float)}}</div>
                  </div>

                  <form action="{{ url_for('main.cart_remove') }}" method="post" class="m-0 remove-form">
                    <input type="hidden" name="item_id" value="{{ it.id }}">
                    <button class="btn btn-outline-danger btn-sm" title="Remove">Ã—</button>
                  </form>
                </div>
              </li>
              {% endfor %}
            </ul>
            <hr>
          {% else %}
            <div class="text-muted mb-4">Your order list is empty. Please select a service to continue!</div>
          {% endif %}

          <div class="d-flex justify-content-between">
            <span class="fw-semibold">Total</span>
            <span class="fw-semibold" id="summary-total">{{"$%.2f"|format(total_cost|float)}} </span>
          </div>
        </div>
      </div>
    </div>
<!-- orser summary pnnel (to here) **PLESE DELETE WHEN YOU MERGE-->

  </div>
</div>

<script>
(function(){
  function clamp(n){ n=parseInt(n||'1',10); if(!Number.isFinite(n)||n<1)n=1; if(n>99)n=99; return n; }

  function recalcTotals(){
    var sum=0;
    document.querySelectorAll('#summary-list > li').forEach(function(li){
      var unit = Number(li.dataset.unit)||0;
      var qty  = Number(li.querySelector('.qty-input')?.value||1);
      var line = unit*qty;
      var cell = li.querySelector('.line-total');
      if(cell) cell.textContent = '$ ' + line.toFixed(2);
      sum += line;
    });
    var totalEl = document.getElementById('summary-total');
    if(totalEl) totalEl.textContent = '$ ' + sum.toFixed(2);
  }

  var submitTimer=null;
  function scheduleSubmit(form){
    clearTimeout(submitTimer);
    submitTimer = setTimeout(function(){ try{ form.submit(); }catch(e){} }, 400);
  }

  document.querySelectorAll('.qty-form').forEach(function(form){
    var dec=form.querySelector('.qty-dec');
    var inc=form.querySelector('.qty-inc');
    var inp=form.querySelector('.qty-input');
    var view=form.querySelector('.qty-view');

    function setQty(v){
      v = clamp(v);
      inp.value = v;
      view.textContent = v;
      recalcTotals();
      scheduleSubmit(form);
    }

    dec.addEventListener('click', function(){ setQty((parseInt(inp.value||'1',10)-1)); });
    inc.addEventListener('click', function(){ setQty((parseInt(inp.value||'1',10)+1)); });
  });

  document.querySelectorAll('.remove-form').forEach(function(rf){
    rf.addEventListener('submit', function(){
      var li = rf.closest('li');
      if(li){ li.remove(); recalcTotals(); }
    });
  });

  document.addEventListener('DOMContentLoaded', recalcTotals);
})();
</script>
{% endblock %}
